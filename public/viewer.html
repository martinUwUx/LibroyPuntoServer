<!DOCTYPE html>
<html>
<head>
    <title>Lector de ePub Digital</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    
    <style>
        /* Estilos básicos para que el visor ocupe toda la pantalla */
        body { 
            margin: 0; 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; /* Altura del viewport */
            overflow: hidden; /* Evita scrolls no deseados en el body */
        }
        #controls { 
            padding: 10px; 
            text-align: center; 
            background-color: #f0f0f0; 
            border-bottom: 1px solid #ccc; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #viewer {
            flex-grow: 1; /* Hace que el visor ocupe el espacio restante */
            width: 100vw; /* Ancho completo del viewport */
            height: calc(100vh - 50px); /* Altura dinámica, ajusta si #controls es más alto */
            margin: 0 auto;
            overflow: hidden; /* Muy importante para el control de renderizado de ePub.js */
        }
        button { 
            padding: 8px 15px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 1px solid #ccc; 
            background-color: #fff;
            border-radius: 5px;
        }
        button:hover {
            background-color: #e9e9e9;
        }
        #location {
            margin-left: 20px;
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="rendition.prev()">&#9664; Página Anterior</button>
        <button onclick="rendition.next()">Página Siguiente &#9654;</button>
        <span id="location">Cargando libro...</span>
    </div>
    <div id="viewer"></div>

    <script>
        // Obtiene los parámetros 'bookId' y 'userToken' del URL del navegador
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('bookId');
        const userToken = urlParams.get('userToken');

        // Verifica si los parámetros esenciales están presentes
        if (!bookId || !userToken) {
            document.getElementById('viewer').innerHTML = '<p style="text-align: center; color: red;">Error: Faltan el ID del libro o el token de usuario. Asegúrate de acceder desde tu aplicación Glide.</p>';
            document.getElementById('location').innerText = 'Error de Acceso';
            // Puedes redirigir a una página de error específica si lo deseas
            // window.location.href = 'https://tu_dominio_de_glide_app/error-acceso';
        } else {
            // La URL base para el contenido del ePub en tu servidor de Render.com.
            // Es la ruta que tu server.js usa para servir los archivos del ePub.
            const bookPath = `/epubs_content/${bookId}`; 

            // Inicializa el libro con ePub.js
            var book = ePub({
                url: bookPath, // ePub.js usará esta URL base para solicitar los archivos del ePub
                method: "get",
                // ¡IMPORTANTE! Añade el token a las cabeceras de las solicitudes de ePub.js.
                // Tu server.js leerá esta cabecera para validar el acceso.
                headers: {
                    "Authorization": userToken 
                }
            });

            // Renderiza el libro en el elemento HTML con ID "viewer"
            var rendition = book.renderTo("viewer", {
                width: "100%",
                height: "100%",
                spread: "always", // 'always' para doble página, 'auto' para que ePub.js decida
                manager: "continuous", // 'continuous' para desplazamiento, 'paginated' para páginas fijas
                flow: "paginated" // Fuerza el paginado (para que funcione bien con los botones de página)
            });

            // Muestra el libro
            rendition.display();

            // Evento que se dispara cuando el lector se mueve de página o ubicación
            rendition.on("relocated", function(location){
                const pageNumber = location.start.displayed.page;
                const totalPages = location.start.displayed.total;
                document.getElementById('location').innerText = `Página ${pageNumber} de ${totalPages}`;
            });

            // Agrega controles de teclado para navegación
            document.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowRight' || event.key === 'PageDown') {
                    rendition.next(); // Avanza a la siguiente página
                } else if (event.key === 'ArrowLeft' || event.key === 'PageUp') {
                    rendition.prev(); // Retrocede a la página anterior
                }
            });

            // Manejo de errores de carga del libro
            book.ready.catch(function(error) {
                console.error("Error al cargar el libro:", error);
                document.getElementById('viewer').innerHTML = '<p style="text-align: center; color: red;">No se pudo cargar el libro. Por favor, intente de nuevo.</p>';
                document.getElementById('location').innerText = 'Error de Carga';
            });
        }
    </script>
</body>
</html>